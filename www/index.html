
<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>website</title>
  <meta name="description" content="website">
  <style type="text/css">
  * { margin: 0; padding: 0 }

  /* ----------------------------------------------
 * Generated by Animista on 2017-6-24 0:53:34
 * w: http://animista.net, t: @cssanimista
 * ---------------------------------------------- */

  @-webkit-keyframes slide-out-fwd-center{0%{-webkit-transform:translateZ(1);transform:translateZ(1);opacity:1}100%{-webkit-transform:translateZ(600px);transform:translateZ(600px);opacity:0}}@keyframes slide-out-fwd-center{0%{-webkit-transform:translateZ(1);transform:translateZ(1);opacity:1}100%{-webkit-transform:translateZ(600px);transform:translateZ(600px);opacity:0}}
  .slide-out-fwd-center{-webkit-animation:slide-out-fwd-center .7s cubic-bezier(.55,.085,.68,.53) both;animation:slide-out-fwd-center .7s cubic-bezier(.55,.085,.68,.53) both}
  </style>
</head>

<body>
  <video id="vid" width="100%" height="100%" preload="none" autoplay>
    <source id="src" src="" type="video/webm">
  </video>
  <script type="text/javascript">
  let video = document.getElementById('vid')
  let source = document.getElementById('src')

  let url = '/poll'
  let playing = false
  let remaining = 0
  function poll() {
    if(playing) {
      console.info('Not polling, video still playing.')
      return
    }
    console.log('polling ..')
    var request = new XMLHttpRequest();
    request.open('GET', url, true);
    request.onload = function() {
      if (this.status >= 200 && this.status < 400) {
        // Success!
        var resp = this.response
        var j = JSON.parse(resp)
        if (j.element) {
          //source.style = 'display:block'
          source.src = j.element
          video.load()
          playing = true
          remaining = j.remaining
          video.classList.remove('slide-out-fwd-center')
        }
        console.info(j)
      }
    }
    request.send()
  }
  setInterval(poll, 5000)

  video.addEventListener('ended', function () {
    console.info('Video has ended, ajax to /ended')
    playing = false
    //source.style = 'display:none'
    video.classList.add('slide-out-fwd-center')
    if (remaining === 0) 
    poll()
  })

  </script>
</body>
</html>
